#!/usr/bin/env python
# coding: utf-8


# Librerías necesarias

import tensorflow as tf
import numpy as np
from tensorflow.keras.preprocessing.image import ImageDataGenerator
from tensorflow.keras.models import Sequential
from tensorflow.keras.layers import Conv2D, MaxPooling2D, Flatten, Dense
from glob import glob
import matplotlib.pyplot as plt



# Rutas de las imágenes de entrenamiento y prueba

train_dir = 'data_malevis/train'
test_dir = 'data_malevis/val'


# In[19]:


# Parámetros de preprocesamiento de imágenes

image_size = (224, 224)  # Tamaño deseado de las imágenes
batch_size = 8          # Tamaño del lote para el entrenamiento


# In[20]:


# Generadores de datos para cargar y preprocesar las imágenes de entrenamiento y prueba

train_datagen = ImageDataGenerator(rescale=1./255)  # Normaliza los valores de píxeles entre 0 y 1
test_datagen = ImageDataGenerator(rescale=1./255)

train_generator = train_datagen.flow_from_directory(
    train_dir,
    target_size=image_size,
    batch_size=batch_size,
    class_mode='categorical')

test_generator = test_datagen.flow_from_directory(
    test_dir,
    target_size=image_size,
    batch_size=batch_size,
    class_mode='categorical')


# In[21]:


# Para obtener las clases de salida

classes = glob('malware_detection/data_malevis/train/*')
classes


# In[22]:


# Para obtener el número de clases de salida

num_classes = len(classes)
num_classes


# In[23]:


# Arquitectura de la red neuronal

model = Sequential()

model.add(Conv2D(32, (3, 3), activation='relu', input_shape=(224, 224, 3)))
model.add(MaxPooling2D((2, 2)))

model.add(Conv2D(64, (3, 3), activation='relu'))
model.add(MaxPooling2D((2, 2)))

model.add(Conv2D(128, (3, 3), activation='relu'))
model.add(MaxPooling2D((2, 2)))

model.add(Flatten())

model.add(Dense(128, activation='relu'))
model.add(Dense(num_classes, activation='softmax'))


# In[9]:


model.summary()


# In[10]:


# Compilación y entrenamiento del modelo

model.compile(optimizer='adam', loss='categorical_crossentropy', metrics=['accuracy'])
history = model.fit(train_generator, epochs=10, validation_data=test_generator)


# In[36]:


# Evaluación del modelo con los datos de test

loss, accuracy = model.evaluate(test_generator)
print(f"Loss: {loss}, Accuracy: {accuracy}")


# In[ ]:


# Gráfica de pérdida (loss)

plt.plot(history.history['loss'], label='Training Loss')
plt.plot(history.history['val_loss'], label='Validation Loss')
plt.xlabel('Epochs')
plt.ylabel('Loss')
plt.legend()
plt.savefig('model1_loss.png')


# In[13]:


# Gráfica de precisión (accuracy)

plt.plot(history.history['accuracy'], label='Training Accuracy')
plt.plot(history.history['val_accuracy'], label='Validation Accuracy')
plt.xlabel('Epochs')
plt.ylabel('Accuracy')
plt.legend()
plt.savefig('model1_acc.png')


# In[39]:


batch_size = 32         # Tamaño del lote para el entrenamiento


# In[40]:


# tests

model2 = Sequential()

model2.add(Conv2D(16, (3, 3), activation='relu', input_shape=(224, 224, 3)))
model2.add(Conv2D(32, (3, 3), activation='relu'))
model2.add(Conv2D(64, (3, 3), activation='relu'))
model2.add(MaxPooling2D((4, 4)))
model2.add(Flatten())
model2.add(Dense(128, activation='relu'))
model2.add(Dense(num_classes, activation='softmax'))


# In[41]:


model2.summary()


# In[42]:


model2.compile(optimizer='adam', loss='categorical_crossentropy', metrics=['accuracy'])
history = model2.fit(train_generator, epochs=10, validation_data=test_generator)


# In[34]:


loss, accuracy = model2.evaluate(test_generator)
print(f"Loss: {loss}, Accuracy: {accuracy}")


# In[34]:

# In[35]:


# Gráfica de pérdida (loss)

plt.plot(history.history['loss'], label='Training Loss')
plt.plot(history.history['val_loss'], label='Validation Loss')
plt.xlabel('Epochs')
plt.ylabel('Loss')
plt.legend()
plt.savefig('model2_loss.png')


# In[37]:


# Gráfica de precisión (accuracy)

plt.plot(history.history['accuracy'], label='Training Accuracy')
plt.plot(history.history['val_accuracy'], label='Validation Accuracy')
plt.xlabel('Epochs')
plt.ylabel('Accuracy')
plt.legend()
plt.savefig('model2_acc.png')


# In[ ]:




