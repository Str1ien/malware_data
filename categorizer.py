import json
import os
import hashlib
import shutil

def sha256(file_path):
    # Create a new SHA-256 hash object
    sha256_hash = hashlib.sha256()

    # Read the file in binary mode and update the hash object with each chunk
    with open(file_path, 'rb') as file:
        while True:
            # Read a chunk of the file (here, 4K bytes at a time)
            chunk = file.read(4096)
            if not chunk:
                break
            sha256_hash.update(chunk)

    # Retrieve the hexadecimal representation of the SHA-256 hash
    return sha256_hash.hexdigest()

# TODO parametrize, argparse...
if __name__ == "__main__":
    hashes = dict()

    with os.scandir("trojan") as trojans:
        for file in trojans:
            hashes[sha256(file)] = "trojan"

    print("Scanned trojans")

    with os.scandir("ransomware/") as rs:
        for file in rs:
            hashes[sha256(file)] = "ransomware"

    print("Scanned ransomware")

    with os.scandir("worm/") as worms:
        for file in worms:
            hashes[sha256(file)] = "worm"

    print("Scanned worms")
    
    with os.scandir("virus/") as virus:
        for file in virus:
            hashes[sha256(file)] = "virus"

    print("Scanned virus")

    with os.scandir("adware/") as adware:
        for file in adware:
            hashes[sha256(file)] = "adware"

    print("Scanned adware")

    with os.scandir("reports/") as reports:
        for report in reports:
            print(report.name)
            with open(report, 'r') as f:
                data = json.load(f)
            
            if "target" in data.keys() and "file" in data["target"] and "sha256" in data["target"]["file"]:
                sha256_hash = data["target"]["file"]["sha256"]
                if sha256_hash in hashes:
                    new_name = f"{hashes[sha256_hash]}_{report.name}"
                    shutil.copy(os.path.join("reports/", report.name), "reports_categorized/")
                    os.rename(os.path.join("reports_categorized/", report.name), os.path.join("reports_categorized/", new_name))
                else:
                    print(f"{sha256_hash} not found in hashes")
            else:
                print("[!] WARNING: No target/file/sha256 in report, skipping...")
