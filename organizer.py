import os
import json
import shutil
import hashlib

def calculate_sha256(file_path):
    # Create a new SHA-256 hash object
    sha256_hash = hashlib.sha256()

    # Read the file in binary mode and update the hash object with each chunk
    with open(file_path, 'rb') as file:
        while True:
            # Read a chunk of the file (here, 4K bytes at a time)
            chunk = file.read(4096)
            if not chunk:
                break
            sha256_hash.update(chunk)

    # Retrieve the hexadecimal representation of the SHA-256 hash
    return sha256_hash.hexdigest()

def copy_json_files(src_dir, dest_dir):
    if not os.path.exists(dest_dir):
        os.makedirs(dest_dir)

    for root, dirs, files in os.walk(src_dir):
        for file in files:
            if file.endswith(".json"):
                src_file = os.path.join(root, file)
                dest_file = os.path.join(dest_dir, file)
                shutil.copy2(src_file, dest_file)
                print(f"Copied {src_file} to {dest_file}")

def main():

    for file in os.listdir("binaries/ransomware"): 
        if os.path.isfile(file): os.remove(os.path.join("binaries/ransomware", file))
    # Directory paths for the malware binaries and reports
    malware_dir = "binaries"
    reports_dir = "reports_5th_batch"
    reports = os.listdir(reports_dir)
    # Gather all the sha256 hashes from the reports
    sha256_reports = {}
    for report_file in reports:
        if report_file.endswith(".json"):
            report_path = os.path.join(reports_dir, report_file)
            with open(report_path, "r") as f:
                report_data = json.load(f)
            sha256_reports[report_data["target"]["file"]["sha256"]] = report_file

    print("sha256 hashes gathered")

    # Reorganize the files
    emparejados = {}
    malware = []
    for category in os.listdir(malware_dir):
        path = os.path.join(malware_dir, category)
        for malware_file in os.listdir(path):
            malware.append(malware_file)
            malware_path = os.path.join(path, malware_file)
            if os.path.isfile(malware_path):
                sha256 = calculate_sha256(malware_path)
                if sha256 in sha256_reports:
                    emparejados[sha256_reports[sha256]] = malware_file
                    dir = os.path.join(path, "_" + sha256)
                    print(dir)
                    os.makedirs(dir, exist_ok=True)
                    shutil.copy(os.path.join(reports_dir, sha256_reports[sha256]), dir)
                    shutil.copy(malware_path, dir)
    print(len(emparejados))

    for report in reports:
        if report not in emparejados.keys():
            print("[!] WARNING: No binary for report", report)
            os.rename(os.path.join(reports_dir, report), os.path.join(reports_dir, "no_binary_" + report))

    destination_dir = "reports_raw"
    copy_json_files("add_to_dataset", destination_dir)

if __name__ == "__main__":
    main()
